<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Multi Clip Video Cutter</title>

<style>
body{font-family:Arial;margin:0;padding:20px;background:#f4f4f4;}
.container{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:10px;}
input,button{padding:8px;border-radius:5px;border:1px solid #ddd;}
button{background:#0066ff;color:#fff;border:0;cursor:pointer;}
button:disabled{background:#888;}
.clip-row{display:flex;gap:10px;margin-top:10px;}
.clip-row input{flex:1;}
.result-box{margin-top:20px;padding:10px;background:#f8f8f8;border-radius:10px;}
.video-preview{margin-top:15px;}
.download-link{display:block;margin-top:5px;padding:8px;background:#10a000;color:white;border-radius:5px;text-decoration:none;width:200px;text-align:center;}
</style>
</head>
<body>

<div class="container">
<h2>Multi Clip Video Cutter</h2>

<label>Upload Video</label><br>
<input type="file" id="fileInput" accept="video/*"><br><br>

<label>Atau URL Video</label><br>
<input type="text" id="urlInput" placeholder="https://..." style="width:100%;"><br><br>

<h3>Clip Waktu</h3>
<div id="clips"></div>
<button onclick="addClip()">+ Tambah Waktu</button>
<br><br>

<button id="processBtn">Mulai Clip Semua</button>

<h3>Status</h3>
<div id="status">Menunggu...</div>

<h3>Hasil Clip</h3>
<div id="result"></div>

<video id="video" controls style="width:100%; margin-top:20px;"></video>

</div>

<script>
const video = document.getElementById("video");
let objectURL = null;

document.getElementById("fileInput").addEventListener("change", e=>{
    if(objectURL) URL.revokeObjectURL(objectURL);
    objectURL = URL.createObjectURL(e.target.files[0]);
    video.src = objectURL;
});

document.getElementById("urlInput").addEventListener("change", e=>{
    if(objectURL) URL.revokeObjectURL(objectURL);
    video.src = e.target.value;
});

function addClip(){
    const row = document.createElement("div");
    row.className = "clip-row";
    row.innerHTML = `
        <input placeholder="Start (detik)" class="start">
        <input placeholder="End (detik)" class="end">
        <button onclick="this.parentElement.remove()">X</button>
    `;
    document.getElementById("clips").appendChild(row);
}

async function seekTo(t){
    return new Promise(res=>{
        video.currentTime = t;
        video.onseeked = ()=>res();
    });
}

async function clipSegment(start, end){
    await seekTo(start);

    let stream, useCanvas = false;
    try {
        stream = video.captureStream();
    } catch {
        useCanvas = true;
    }

    if(useCanvas){
        const c = document.createElement("canvas");
        c.width = video.videoWidth;
        c.height = video.videoHeight;
        const ctx = c.getContext("2d");

        function draw(){
            ctx.drawImage(video,0,0,c.width,c.height);
            if(!video.paused) requestAnimationFrame(draw);
        }
        draw();

        stream = c.captureStream(30);
    }

    const chunks = [];
    const rec = new MediaRecorder(stream, { mimeType:"video/webm" });

    return new Promise(async resolve=>{
        rec.ondataavailable = e => chunks.push(e.data);
        rec.onstop = ()=>{
            resolve(new Blob(chunks,{type:"video/webm"}));
        };

        rec.start();
        video.play();

        const interval = setInterval(()=>{
            if(video.currentTime >= end){
                clearInterval(interval);
                video.pause();
                rec.stop();
            }
        },50);
    });
}

document.getElementById("processBtn").addEventListener("click", async()=>{
    const ranges = [...document.querySelectorAll(".clip-row")].map(r=>{
        return {
            start: Number(r.querySelector(".start").value),
            end: Number(r.querySelector(".end").value)
        };
    });

    if(ranges.length === 0) return alert("Tambahkan minimal 1 waktu clip");

    document.getElementById("status").innerText = "Memulai proses...";

    const resultBox = document.getElementById("result");
    resultBox.innerHTML = "";

    await video.play().catch(()=>{});
    await video.pause();

    await video.onloadedmetadata;

    for(let i=0;i<ranges.length;i++){
        const {start,end} = ranges[i];
        document.getElementById("status").innerText = `Memotong bagian ${i+1}/${ranges.length}...`;

        const blob = await clipSegment(start,end);
        const url = URL.createObjectURL(blob);

        // BUAT PREVIEW VIDEO
        const vid = document.createElement("video");
        vid.src = url;
        vid.controls = true;
        vid.className = "video-preview";

        const a = document.createElement("a");
        a.href = url;
        a.download = `clip_${start}-${end}.webm`;
        a.className = "download-link";
        a.innerText = `Download Clip ${start}-${end}`;

        const box = document.createElement("div");
        box.appendChild(vid);
        box.appendChild(a);

        resultBox.appendChild(box);
    }

    document.getElementById("status").innerText = "Selesai! Semua clip muncul di bawah.";
});
</script>

</body>
</html>
